<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Katalepsis Lab | Personal Macro Sandbox</title>
  <style>
    :root {
      --bg: #0d141f;
      --panel: #121c2b;
      --card: #162338;
      --text: #e9eef5;
      --muted: #c4d2e0;
      --accent: #6ee7b7;
      --accent-strong: #42c498;
      --edge: rgba(255, 255, 255, 0.08);
      --shadow: 0 18px 46px rgba(0, 0, 0, 0.35);
      --radius: 14px;
    }

    * { box-sizing: border-box; }

    html { scroll-behavior: smooth; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 20% 20%, rgba(110, 231, 183, 0.08), transparent 26%),
                  radial-gradient(circle at 82% 10%, rgba(110, 231, 183, 0.12), transparent 24%),
                  linear-gradient(130deg, #090f19 0%, #0f1726 35%, #0b1322 100%);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    a { color: var(--accent); }

    header {
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(12px);
      background: rgba(9, 15, 25, 0.82);
      border-bottom: 1px solid var(--edge);
    }

    .nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px 22px;
      gap: 14px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      letter-spacing: 0.6px;
      color: var(--text);
      text-decoration: none;
    }

    .logo-mark {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(110, 231, 183, 0.15), rgba(66, 196, 152, 0.45));
      border: 1px solid var(--edge);
      box-shadow: 0 0 0 6px rgba(110, 231, 183, 0.14), 0 12px 30px rgba(0, 0, 0, 0.28);
    }

    .logo span {
      display: block;
      line-height: 1.2;
    }

    .logo .brand { font-size: 1rem; }
    .logo .tagline { font-size: 0.85rem; color: var(--muted); font-weight: 500; }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .nav-links a {
      color: var(--text);
      text-decoration: none;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid transparent;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .nav-links a:hover,
    .nav-links a:focus-visible {
      color: var(--accent);
      border-color: var(--edge);
      background: rgba(255, 255, 255, 0.04);
    }

    .nav-toggle {
      display: none;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid var(--edge);
      color: var(--text);
      border-radius: 10px;
      padding: 10px;
      cursor: pointer;
    }

    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 28px 22px 80px;
    }

    section { margin-bottom: 70px; }

    .hero {
      margin: 28px 0 70px;
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 28px;
      align-items: center;
    }

    .eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: var(--muted);
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--edge);
      border-radius: 999px;
      padding: 10px 14px;
    }

    .eyebrow .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(110, 231, 183, 0.2);
    }

    h1 {
      font-size: clamp(2.2rem, 4vw, 3.4rem);
      margin: 16px 0 12px;
      letter-spacing: -0.4px;
    }

    .lede {
      font-size: 1.05rem;
      color: #dfe7f1;
      max-width: 640px;
    }

    .hero-cta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 24px 0 10px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 700;
      border: 1px solid var(--edge);
      text-decoration: none;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, color 0.2s ease;
      cursor: pointer;
      color: var(--text);
      background: rgba(255, 255, 255, 0.03);
    }

    .btn-primary {
      background: linear-gradient(120deg, var(--accent) 0%, var(--accent-strong) 100%);
      color: #041118;
      box-shadow: 0 12px 30px rgba(66, 196, 152, 0.35);
    }

    .btn:hover,
    .btn:focus-visible {
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.32);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
    }

    .btn-primary:hover,
    .btn-primary:focus-visible {
      background: linear-gradient(120deg, var(--accent) 0%, #93f3d3 100%);
    }

    .panel {
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0));
      border: 1px solid var(--edge);
      border-radius: var(--radius);
      padding: 22px;
      box-shadow: var(--shadow);
    }

    .hero-panel {
      display: grid;
      gap: 16px;
      border-image: linear-gradient(120deg, rgba(110, 231, 183, 0.4), rgba(110, 231, 183, 0)) 1;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--muted);
      background: rgba(255, 255, 255, 0.03);
    }

    .section-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 14px;
      margin-bottom: 22px;
      flex-wrap: wrap;
    }

    .section-header h2 { margin: 0; font-size: 1.6rem; letter-spacing: -0.2px; }
    .section-header p { margin: 0; color: var(--muted); max-width: 620px; }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }

    .card {
      border-radius: var(--radius);
      border: 1px solid var(--edge);
      background: var(--card);
      padding: 20px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -1px;
      background: linear-gradient(140deg, rgba(110, 231, 183, 0.15), transparent 55%);
      z-index: 0;
      opacity: 0;
      transition: opacity 0.25s ease;
    }

    .card:hover::before { opacity: 1; }

    .card h3 { margin: 0 0 8px; }
    .card p { margin: 0 0 12px; color: #d6e1ec; }

    .status {
      display: inline-flex;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(110, 231, 183, 0.08);
      border: 1px solid rgba(110, 231, 183, 0.25);
      color: var(--text);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .tiles {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }

    .tile {
      border: 1px solid var(--edge);
      border-radius: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.02);
    }

    .tile .label { color: var(--muted); font-size: 0.9rem; }
    .tile .value { font-weight: 700; margin-top: 6px; }

    .grid-two {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
    }

    .about-block {
      margin-top: 18px;
      background: var(--card);
      border-radius: var(--radius);
      padding: 18px;
      border: 1px solid var(--edge);
      color: var(--muted);
      box-shadow: var(--shadow);
    }

    .note {
      font-size: 0.95rem;
      color: var(--muted);
      margin-top: 12px;
    }

    .chat-grid {
      display: grid;
      grid-template-columns: 0.38fr 0.62fr;
      gap: 16px;
      align-items: start;
    }

    .chat-config {
      display: grid;
      gap: 12px;
    }

    label { display: block; font-weight: 600; margin-bottom: 6px; }

    input[type="text"],
    input[type="password"],
    textarea {
      width: 100%;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--edge);
      border-radius: 10px;
      padding: 10px 12px;
      color: var(--text);
      font-family: inherit;
    }

    textarea { resize: vertical; min-height: 60px; }

    .help { color: var(--muted); font-size: 0.92rem; margin-top: 4px; }

    .chat-window {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--edge);
      min-height: 420px;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow);
      padding: 12px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: stretch;
      align-content: flex-start;
    }

    .message { display: flex; align-items: flex-start; }
    .message.user { justify-content: flex-end; }

    .bubble {
      max-width: 90%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--edge);
      background: rgba(255, 255, 255, 0.02);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.25);
      line-height: 1.45;
    }

    .message.user .bubble {
      background: rgba(110, 231, 183, 0.12);
      border-color: rgba(110, 231, 183, 0.35);
      color: var(--text);
    }

    .message.assistant .bubble { color: var(--text); }

    .bubble p { margin: 0 0 8px; }
    .bubble p:last-child { margin-bottom: 0; }

    .bubble strong { color: #f2f7ff; }
    .bubble em { color: #d8e7ff; }

    .bubble code.inline-code {
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid var(--edge);
      padding: 2px 6px;
      border-radius: 8px;
      font-family: "SFMono-Regular", "Consolas", "Monaco", monospace;
      font-size: 0.95rem;
      color: var(--text);
    }

    .bubble pre.code-block {
      background: #0b1625;
      border: 1px solid var(--edge);
      border-radius: 12px;
      padding: 12px;
      overflow-x: auto;
      font-family: "SFMono-Regular", "Consolas", "Monaco", monospace;
      font-size: 0.95rem;
      color: var(--text);
      margin: 8px 0 0;
    }

    .bubble pre.code-block code { white-space: pre; display: block; }

    .bubble table.md-table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      border: 1px solid var(--edge);
      background: rgba(255, 255, 255, 0.02);
      border-radius: 10px;
      overflow: hidden;
    }

    .bubble table.md-table th,
    .bubble table.md-table td {
      padding: 8px 10px;
      border: 1px solid var(--edge);
      text-align: left;
      font-size: 0.96rem;
    }

    .bubble table.md-table th {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
      font-weight: 700;
    }

    .bubble table.md-table tr:nth-child(even) td {
      background: rgba(255, 255, 255, 0.03);
    }

    .bubble hr.md-hr {
      border: none;
      border-top: 1px solid var(--edge);
      margin: 14px 0;
    }

    .bubble h1,
    .bubble h2,
    .bubble h3,
    .bubble h4,
    .bubble h5,
    .bubble h6 {
      margin: 0 0 10px;
      line-height: 1.3;
      font-weight: 700;
    }

    .bubble h1 { font-size: 1.4rem; }
    .bubble h2 { font-size: 1.25rem; }
    .bubble h3 { font-size: 1.15rem; }
    .bubble h4 { font-size: 1.08rem; }
    .bubble h5,
    .bubble h6 { font-size: 1rem; }

    .md-list {
      margin: 6px 0 10px 18px;
      padding: 0 0 0 12px;
      color: var(--text);
    }

    .md-list li { margin: 6px 0; }

    .chat-input {
      border-top: 1px solid var(--edge);
      padding: 10px;
      display: flex;
      gap: 8px;
      background: rgba(5, 8, 14, 0.65);
      backdrop-filter: blur(6px);
      position: sticky;
      bottom: 0;
      margin: 0 4px 4px;
      border-radius: var(--radius);
    }

    .chat-input textarea {
      min-height: 48px;
      max-height: 120px;
    }

    .error {
      color: #ffb4a2;
      font-size: 0.95rem;
      margin: 6px 0 0;
    }

    footer {
      border-top: 1px solid var(--edge);
      padding: 24px 22px 40px;
      color: var(--muted);
      font-size: 0.95rem;
      background: rgba(5, 8, 14, 0.7);
    }

    @media (max-width: 920px) {
      .hero { grid-template-columns: 1fr; }
      .chat-grid { grid-template-columns: 1fr; }
      .chat-window { min-height: 360px; }
      .chat-input { position: static; }
      .nav-links { display: none; }
      .nav-toggle { display: inline-flex; }
      .nav.open .nav-links {
        display: flex;
        flex-direction: column;
        width: 100%;
        background: rgba(7, 12, 20, 0.94);
        padding: 12px;
        border: 1px solid var(--edge);
        border-radius: 12px;
      }
      .nav { align-items: flex-start; }
    }
  </style>
</head>
<body>
  <header>
    <div class="nav" id="siteNav">
      <a class="logo" href="#home">
        <div class="logo-mark" aria-hidden="true"></div>
        <div>
          <span class="brand">Katalepsis Lab</span>
          <span class="tagline">Macro research sandbox</span>
        </div>
      </a>
      <button class="nav-toggle" aria-label="Toggle navigation" id="navToggle">Menu</button>
      <nav class="nav-links" aria-label="Primary">
        <a href="#home">Home</a>
        <a href="#dashboards">Dashboards</a>
        <a href="#chatbot">Chatbot</a>
        <a href="cv.html">CV</a>
      </nav>
    </div>
  </header>

  <main>
    <section class="hero" id="home">
      <div>
        <div class="eyebrow"><span class="dot"></span><span>Personal macro lab</span></div>
        <h1>Katalepsis Lab · Macro dashboards, portfolio sandboxes, zero sales pitch.</h1>
        <p class="lede">A place where I tinker with data pipelines, macro dashboards, and portfolio optimizers. Everything here is experimental, educational, and actively changing.</p>
        <div class="hero-cta">
          <a class="btn btn-primary" href="#dashboards">View dashboards</a>
          <a class="btn" href="#chatbot">Try the chatbot</a>
        </div>
        <div class="chips">
          <span class="pill">Macro data plumbing</span>
          <span class="pill">Regime detection experiments</span>
          <span class="pill">Portfolio sandbox</span>
        </div>
        <div class="about-block">
          <strong>About the project:</strong>
          <p style="margin: 8px 0 0;">Learning in public by building my own tools. No clients, no sales funnel—just a working bench for macro dashboards and portfolio ideas. Not investment advice.</p>
        </div>
      </div>
      <div class="panel hero-panel">
        <div>
          <h3 style="margin: 0 0 8px;">What I'm building</h3>
          <div class="chips">
            <span class="pill">Data pipelines</span>
            <span class="pill">Nowcast dashboards</span>
            <span class="pill">Portfolio experiments</span>
            <span class="pill">Notes & docs</span>
          </div>
        </div>
        <div class="grid-two">
          <div class="tile">
            <div class="label">Current focus</div>
            <div class="value">US + Canada macro plumbing</div>
          </div>
          <div class="tile">
            <div class="label">Working principle</div>
            <div class="value">Evidence over hype. Ship small.</div>
          </div>
        </div>
      </div>
    </section>

    <section id="dashboards">
      <div class="section-header">
        <div>
          <h2>Macro Dashboards</h2>
          <p>Work in progress: personal dashboards for growth, inflation, liquidity, and policy signals. UI is being scaffolded while data pipelines firm up.</p>
        </div>
        <span class="status">Status: data plumbing nearly ready</span>
      </div>

      <div class="cards">
        <article class="card">
          <h3>United States</h3>
          <p>Growth, inflation, policy stance, term structure, liquidity, and market tone. Built for quick regime reads.</p>
          <span class="status">Status: data pipeline almost ready, UI under construction.</span>
          <div class="tiles">
            <div class="tile">
              <div class="label">Growth Nowcast</div>
              <div class="value">Last updated: coming soon</div>
            </div>
            <div class="tile">
              <div class="label">Inflation Pulse</div>
              <div class="value">Sticky CPI, PCE preview</div>
            </div>
            <div class="tile">
              <div class="label">Curve & Term Premium</div>
              <div class="value">Filling in estimates</div>
            </div>
            <div class="tile">
              <div class="label">Risk Appetite</div>
              <div class="value">Equity breadth + credit</div>
            </div>
          </div>
        </article>

        <article class="card">
          <h3>Canada</h3>
          <p>Housing, labor market, BoC path, regional spreads, and market breadth. Built to sense turning points early.</p>
          <span class="status">Status: data pipeline almost ready, UI under construction.</span>
          <div class="tiles">
            <div class="tile">
              <div class="label">Housing Pulse</div>
              <div class="value">Inventory & affordability</div>
            </div>
            <div class="tile">
              <div class="label">Labor Market</div>
              <div class="value">Unemployment & wage trend</div>
            </div>
            <div class="tile">
              <div class="label">BoC Path</div>
              <div class="value">Market-implied cuts</div>
            </div>
            <div class="tile">
              <div class="label">Spreads & Breakevens</div>
              <div class="value">Coming soon</div>
            </div>
          </div>
        </article>
      </div>

      <div class="note">These dashboards are personal research tools. They are not trading recommendations.</div>
    </section>

    <section id="chatbot">
      <div class="section-header">
        <div>
          <h2>Portfolio Management Chatbot</h2>
          <p>A personal experiment that discusses allocations, risk, and macro views. Front-end only—connects to a Python backend you host elsewhere. Not financial advice.</p>
        </div>
        <span class="status">Experiment</span>
      </div>

      <div class="chat-grid">
        <div class="panel chat-config">
          <div>
            <h3 style="margin: 0 0 6px;">Connection</h3>
            <p class="help">Point this UI at your backend endpoint. Defaults to a placeholder.</p>
          </div>
          <div>
            <label for="backendUrl">Backend URL</label>
            <input type="text" id="backendUrl" name="backendUrl" aria-label="Backend URL" />
            <p class="help">Change to your Python service endpoint (POST). <!-- Update this value to your real backend URL. --></p>
          </div>
          <div>
            <label for="apiKey">OpenAI API key (optional)</label>
            <input type="password" id="apiKey" name="apiKey" aria-label="OpenAI API key" autocomplete="off" />
            <p class="help">Used only in your browser requests and not stored on a server from this site.</p>
          </div>
          <div class="note">Your key is kept in this browser only so requests can include it. Nothing is logged.</div>
        </div>

        <div class="chat-window">
          <div class="chat-messages" id="chatMessages" aria-live="polite"></div>
          <div class="chat-input">
            <form id="chatForm" style="display: contents;">
              <textarea id="chatMessage" name="chatMessage" placeholder="Ask about allocations, risk, or a macro view..." aria-label="Message"></textarea>
              <button type="submit" class="btn btn-primary" id="sendBtn">Send</button>
            </form>
          </div>
          <div class="error" id="chatError" role="alert" aria-live="assertive"></div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="nav" style="padding: 0; max-width: 1100px;">
      <div>
        <strong>Katalepsis Lab</strong>
        <div class="help">All content is for research and educational purposes. Nothing here is investment advice.</div>
      </div>
      <div class="help">Built as a personal lab for macro dashboards & portfolio tools.<br>
        Front-end scaffolding originally generated with Codex (OpenAI).</div>
    </div>
  </footer>

  <script>
    const navToggle = document.getElementById("navToggle");
    const siteNav = document.getElementById("siteNav");
    navToggle?.addEventListener("click", () => {
      siteNav.classList.toggle("open");
    });

    // Update this to point to your actual Python backend.
    const DEFAULT_BACKEND_URL = "https://katalepsis-lab.app.n8n.cloud/webhook/chat"; // This is the testing webhook, change for prod.
    const backendUrlInput = document.getElementById("backendUrl");
    backendUrlInput.value = DEFAULT_BACKEND_URL;

    const apiKeyInput = document.getElementById("apiKey");
    const chatMessagesEl = document.getElementById("chatMessages");
    const chatForm = document.getElementById("chatForm");
    const chatMessageInput = document.getElementById("chatMessage");
    const chatError = document.getElementById("chatError");
    const sendBtn = document.getElementById("sendBtn");

    const storedKey = window.localStorage.getItem("katalepsis-openai-key");
    if (storedKey) apiKeyInput.value = storedKey;

    const RATE_LIMIT_COUNT = 25;
    const RATE_LIMIT_WINDOW_MS = 60 * 60 * 1000; // 1 hour
    const RATE_LIMIT_STORAGE_KEY = "katalepsis-rate-limit";

    function loadRateLimit() {
      try {
        const raw = window.localStorage.getItem(RATE_LIMIT_STORAGE_KEY);
        const parsed = raw ? JSON.parse(raw) : [];
        return Array.isArray(parsed) ? parsed : [];
      } catch (_) {
        return [];
      }
    }

    function saveRateLimit(stamps) {
      try {
        window.localStorage.setItem(RATE_LIMIT_STORAGE_KEY, JSON.stringify(stamps));
      } catch (_) {
        // ignore storage errors
      }
    }

    function pruneRateLimit(stamps) {
      const now = Date.now();
      return stamps.filter((ts) => now - ts < RATE_LIMIT_WINDOW_MS);
    }

    const messages = [
      {
        role: "assistant",
        text: "Hi - this is a portfolio management chatbot experiment. I can discuss allocations, risk budgets, and macro narratives. Not investment advice."
      }
    ];

    function renderMessages() {
      chatMessagesEl.innerHTML = messages.map((msg) => {
        const side = msg.role === "user" ? "user" : "assistant";
        return '<div class="message ' + side + '"><div class="bubble">' + renderMarkdownSafe(msg.text) + "</div></div>";
      }).join("");
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    function escapeHtml(unsafe) {
      return unsafe.replace(/[&<>"']/g, (m) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#039;"
      }[m]));
    }

    function renderMarkdownSafe(raw) {
      const codeBlocks = [];
      let text = (raw || "").replace(/\r\n?/g, "\n");

      text = text.replace(/```(\w+)?\n?([\s\S]*?)```/g, (_, lang, code) => {
        const language = lang ? lang.trim() : "";
        const escapedCode = escapeHtml(code.trim());
        const placeholder = "@@CODEBLOCK" + codeBlocks.length + "@@";
        const langAttr = language ? ' data-lang="' + escapeHtml(language) + '"' : "";
        const classAttr = language ? ' class="language-' + escapeHtml(language) + '"' : "";
        codeBlocks.push('<pre class="code-block"' + langAttr + '><code' + classAttr + ">" + escapedCode + "</code></pre>");
        return placeholder;
      });

      text = escapeHtml(text);
      text = text.replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>');
      text = text.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
      text = text.replace(/\*(.+?)\*/g, "<em>$1</em>");

      const lines = text.split("\n");
      const htmlParts = [];
      let inList = false;
      const flushList = () => {
        if (inList) {
          htmlParts.push("</ul>");
          inList = false;
        }
      };

      const parseCells = (row) => row.split("|").map((c) => c.trim()).filter((c, i, arr) => !(i === 0 && c === "") && !(i === arr.length - 1 && c === ""));

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];

        const headingMatch = line.match(/^\s*(#{1,6})\s+(.*)/);
        if (headingMatch) {
          flushList();
          const level = Math.min(headingMatch[1].length, 6);
          htmlParts.push("<h" + level + ">" + headingMatch[2].trim() + "</h" + level + ">");
          continue;
        }

        if (/^\s*[-*_]{3,}\s*$/.test(line)) {
          flushList();
          htmlParts.push('<hr class="md-hr">');
          continue;
        }

        const nextLine = lines[i + 1];
        if (nextLine && /\|/.test(line) && /^\s*\|?\s*:?-{3,}/.test(nextLine)) {
          flushList();
          const headerCells = parseCells(line);
          const bodyRows = [];
          i += 2;
          while (i < lines.length && /\|/.test(lines[i]) && !/^\s*$/.test(lines[i])) {
            bodyRows.push(parseCells(lines[i]));
            i++;
          }
          i -= 1;

          htmlParts.push('<table class="md-table"><thead><tr>' + headerCells.map((cell) => "<th>" + cell + "</th>").join("") + "</tr></thead>");
          htmlParts.push("<tbody>");
          bodyRows.forEach((row) => {
            htmlParts.push("<tr>" + row.map((cell) => "<td>" + cell + "</td>").join("") + "</tr>");
          });
          htmlParts.push("</tbody></table>");
          continue;
        }

        const listMatch = line.match(/^\s*[-*]\s+(.*)/);
        if (listMatch) {
          if (!inList) {
            htmlParts.push('<ul class="md-list">');
            inList = true;
          }
          htmlParts.push("<li>" + listMatch[1] + "</li>");
        } else if (line.trim() === "") {
          flushList();
          if (i !== lines.length - 1) htmlParts.push("<br>");
        } else {
          flushList();
          htmlParts.push("<p>" + line + "</p>");
        }
      }

      flushList();

      let html = htmlParts.join("");
      codeBlocks.forEach((block, idx) => {
        html = html.replace("@@CODEBLOCK" + idx + "@@", block);
      });

      return html;
    }

    async function sendMessageToBackend(message, openaiKey, backendUrl) {
      // Adjust field names here if your backend expects different keys.
      const payload = {
        message,
        openai_api_key: openaiKey || undefined
      };

      const response = await fetch(backendUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        let detail = "";
        try {
          const errData = await response.json();
          detail = errData?.detail || errData?.message || "";
        } catch (_) {
          try {
            detail = await response.text();
          } catch (_) {
            detail = "";
          }
        }
        const baseMsg = detail || "Backend returned " + response.status;
        if (response.status === 429) {
          throw new Error(
            detail || "Rate limit reached: 25 messages per hour without your own API key. Please add your key or come back later."
          );
        }
        throw new Error(baseMsg);
      }

      const data = await response.json();
      // Adjust the property used below if your backend returns a different shape.
      return data.reply || data.message || "Response received (adjust parsing to match your backend).";
    }

    chatMessageInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter" && !event.shiftKey && !event.isComposing) {
        event.preventDefault();
        if (!sendBtn.disabled) {
          // Use form submission so the existing handler runs.
          chatForm.requestSubmit();
        }
      }
    });

    chatForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      const text = chatMessageInput.value.trim();
      if (!text) return;

      chatError.textContent = "";
      const backendUrl = backendUrlInput.value.trim() || DEFAULT_BACKEND_URL;
      const openaiKey = apiKeyInput.value.trim();
      if (openaiKey) {
        window.localStorage.setItem("katalepsis-openai-key", openaiKey);
      } else {
        window.localStorage.removeItem("katalepsis-openai-key");
      }

      if (!openaiKey) {
        let stamps = pruneRateLimit(loadRateLimit());
        if (stamps.length >= RATE_LIMIT_COUNT) {
          const limitMsg = "Rate limit reached: 25 messages per hour without your own API key. Please add your key or try again later.";
          messages.push({ role: "assistant", text: limitMsg });
          chatError.textContent = "Error: " + limitMsg;
          renderMessages();
          return;
        }
        stamps.push(Date.now());
        saveRateLimit(stamps);
      }

      messages.push({ role: "user", text });
      renderMessages();
      chatMessageInput.value = "";
      sendBtn.disabled = true;
      sendBtn.textContent = "Thinking…";

      try {
        const reply = await sendMessageToBackend(text, openaiKey, backendUrl);
        messages.push({ role: "assistant", text: reply });
      } catch (err) {
        const friendly = err && err.message ? err.message : "Unable to reach backend";
        messages.push({ role: "assistant", text: friendly });
        chatError.textContent = "Error: " + friendly;
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = "Send";
        renderMessages();
      }
    });

    renderMessages();
  </script>
</body>
</html>

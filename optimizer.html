<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Katalepsis Lab | Optimizer MVP</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body data-page="optimizer">
  <header>
    <div class="nav" id="siteNav">
      <a class="logo" href="index.html#home">
        <div class="logo-mark" aria-hidden="true"></div>
        <div>
          <span class="brand">Katalepsis Lab</span>
          <span class="tagline">Macro research sandbox</span>
        </div>
      </a>
      <button class="nav-toggle" aria-label="Toggle navigation" id="navToggle">Menu</button>
      <nav class="nav-links" aria-label="Primary">
        <a class="nav-link" data-page="home" href="index.html#home">Home</a>
        <a class="nav-link" data-page="dashboards" href="index.html#dashboards">Dashboards</a>
        <a class="nav-link" data-page="chatbot" href="index.html#chatbot">Chatbot</a>
        <a class="nav-link" data-page="optimizer" href="optimizer.html">Optimizer</a>
        <a class="nav-link" data-page="cv" href="cv.html">CV</a>
      </nav>
    </div>
  </header>

  <main>
    <section class="section-header" style="margin-bottom: 26px;">
      <div>
        <h1 style="margin: 0;">Portfolio Optimizer MVP</h1>
        <p class="lede">Feed a macro regime, get suggested asset-class bands, then run an optimization against the hosted backend.</p>
      </div>
      <span class="status">MVP</span>
    </section>

    <div class="optimizer-layout">
      <div class="optimizer-column">
        <div class="panel">
          <div>
            <h3 style="margin: 0 0 6px;">Connection</h3>
            <p class="help" style="margin: 0;">Point the optimizer at your backend and optionally forward your own OpenAI key. The key is only sent with each request and never stored.</p>
          </div>
          <div style="margin-top: 10px;">
            <label for="optimizerBackendUrl">Backend URL</label>
            <input type="text" id="optimizerBackendUrl" name="optimizerBackendUrl" aria-label="Optimizer backend URL" placeholder="https://optimizer-e4vz.onrender.com" />
          </div>
          <div style="margin-top: 10px;">
            <label for="optimizerApiKey">OpenAI API key</label>
            <textarea id="optimizerApiKey" name="optimizerApiKey" aria-label="OpenAI API key" rows="2" placeholder="Paste your sk- key. It is sent only with each request and never stored."></textarea>
          </div>
        </div>

        <div class="panel chat-panel">
          <div>
            <h3 style="margin: 0 0 6px;">Macro view chat</h3>
            <p class="help" style="margin: 0;">Enter a macro regime (e.g. soft landing, stagflation, deflation shock). The backend returns suggested asset-class bands.</p>
          </div>
          <div class="chat-history" id="optimizerChatHistory" aria-live="polite"></div>
          <div class="chat-input-bar">
            <textarea id="macroInput" name="macroInput" placeholder="Type a macro regime (and any constraints)..." aria-label="Macro view input"></textarea>
            <button class="btn btn-primary" id="optimizerSend" type="button">Send</button>
          </div>
        </div>
      </div>

      <div class="optimizer-column">
        <div class="panel allocation-panel">
          <h3>Asset-class allocation (bands)</h3>
          <p class="help">AI suggestions land here. You can adjust manually before confirming.</p>
          <form class="allocation-form" id="allocationForm">
            <div class="allocation-row">
              <label for="alloc-equities">Equities</label>
              <select id="alloc-equities" name="equities">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
            </div>
            <div class="allocation-row">
              <label for="alloc-fixed-income">Fixed Income</label>
              <select id="alloc-fixed-income" name="fixed_income">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
            </div>
            <div class="allocation-row">
              <label for="alloc-commodities">Commodities</label>
              <select id="alloc-commodities" name="commodities">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
            </div>
            <div class="allocation-row">
              <label for="alloc-alternatives">Alternatives</label>
              <select id="alloc-alternatives" name="alternatives">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
            </div>
            <div class="allocation-row">
              <label for="alloc-cash">Cash</label>
              <select id="alloc-cash" name="cash">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
            </div>
          </form>
          <div class="control-buttons">
            <button class="btn btn-primary" type="button" id="confirmBandsBtn">Confirm allocation bands</button>
          </div>
          <p class="help" style="margin: 4px 0 0;">After confirming, choose whether to refresh data before running the optimization.</p>
        </div>

        <div class="panel">
          <h3 style="margin: 0 0 8px;">Optimization snapshot</h3>
          <p class="help" style="margin: 0 0 10px;">Mock weights update after each run.</p>
          <table class="mini-table">
            <thead>
              <tr>
                <th>Ticker</th>
                <th>Weight (%)</th>
              </tr>
            </thead>
            <tbody id="weightsTableBody">
              <tr><td colspan="2" class="help">No optimization run yet.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script>
    const navToggle = document.getElementById("navToggle");
    const siteNav = document.getElementById("siteNav");
    navToggle?.addEventListener("click", () => {
      siteNav.classList.toggle("open");
    });

    const activePage = document.body?.dataset?.page;
    document.querySelectorAll(".nav-link").forEach((link) => {
      if (link.dataset.page === activePage) {
        link.classList.add("active");
      }
      link.addEventListener("click", () => siteNav.classList.remove("open"));
    });

    // Optimizer-specific UI wiring stays isolated to this page.
    if (document.body?.dataset?.page === "optimizer") {
      const chatHistory = document.getElementById("optimizerChatHistory");
      const macroInput = document.getElementById("macroInput");
      const sendBtn = document.getElementById("optimizerSend");
      const confirmBandsBtn = document.getElementById("confirmBandsBtn");
      const weightsTableBody = document.getElementById("weightsTableBody");
      const backendUrlInput = document.getElementById("optimizerBackendUrl");
      const apiKeyInput = document.getElementById("optimizerApiKey");
      const DEFAULT_OPTIMIZER_BACKEND_URL = "https://optimizer-e4vz.onrender.com";
      if (backendUrlInput) backendUrlInput.value = DEFAULT_OPTIMIZER_BACKEND_URL;

      const allocationSelects = {
        equities: document.getElementById("alloc-equities"),
        fixed_income: document.getElementById("alloc-fixed-income"),
        commodities: document.getElementById("alloc-commodities"),
        alternatives: document.getElementById("alloc-alternatives"),
        cash: document.getElementById("alloc-cash")
      };

      let confirmedBands = {
        equities: "medium",
        fixed_income: "medium",
        commodities: "medium",
        alternatives: "medium",
        cash: "medium"
      };
      let currentProposalId = null;

      function appendMessage(role, text, options = {}) {
        const entry = document.createElement("div");
        entry.className = "chat-entry " + (role === "user" ? "user" : "assistant");
        const bubble = document.createElement("div");
        bubble.className = "bubble";
        if (options.asHtml) {
          bubble.innerHTML = text;
        } else {
          bubble.textContent = text;
        }
        entry.appendChild(bubble);
        chatHistory.appendChild(entry);
        chatHistory.scrollTop = chatHistory.scrollHeight;
        return { entry, bubble };
      }

      function getApiBaseUrl() {
        const raw = backendUrlInput?.value?.trim() || DEFAULT_OPTIMIZER_BACKEND_URL;
        return raw.replace(/\/+$/, "");
      }

      async function readErrorDetail(response) {
        try {
          const errData = await response.json();
          return errData?.detail || errData?.message || JSON.stringify(errData);
        } catch (_) {
          return "";
        }
      }

      async function postJson(url, body) {
        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body ?? {})
        });
        if (!response.ok) {
          const detail = await readErrorDetail(response);
          throw new Error(detail || "Backend returned " + response.status);
        }
        return response.json();
      }

      function applyAllocationSuggestion(allocations) {
        Object.entries(allocations || {}).forEach(([key, value]) => {
          if (allocationSelects[key]) {
            allocationSelects[key].value = value;
          }
        });
      }

      function readBandsFromForm() {
        return {
          equities: allocationSelects.equities.value,
          fixed_income: allocationSelects.fixed_income.value,
          commodities: allocationSelects.commodities.value,
          alternatives: allocationSelects.alternatives.value,
          cash: allocationSelects.cash.value
        };
      }

      function setWeightsTable(weights) {
        if (!weightsTableBody) return;
        weightsTableBody.innerHTML = "";
        if (!weights || weights.length === 0) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 2;
          cell.className = "help";
          cell.textContent = "No weights above 1% returned.";
          row.appendChild(cell);
          weightsTableBody.appendChild(row);
          return;
        }
        weights.forEach((rowItem) => {
          const row = document.createElement("tr");
          const tickerCell = document.createElement("td");
          tickerCell.textContent = rowItem.ticker;
          const weightCell = document.createElement("td");
          weightCell.textContent = (rowItem.weight * 100).toFixed(0) + "%";
          row.appendChild(tickerCell);
          row.appendChild(weightCell);
          weightsTableBody.appendChild(row);
        });
      }

      async function handleMacroViewSubmit(message, thinkingHandle) {
        const apiBase = getApiBaseUrl();
        const openaiKey = apiKeyInput?.value?.trim();
        if (!openaiKey) {
          thinkingHandle?.entry?.remove();
          appendMessage("assistant", "Add your OpenAI API key, then try again.");
          return;
        }

        try {
          const data = await postJson(apiBase + "/proposal", {
            api_key: openaiKey,
            macro_regime: message
          });
          const allocations = data?.qualitative_allocations || {};
          const justification = data?.justification || "Proposal received.";
          currentProposalId = data?.proposal_id || currentProposalId;

          thinkingHandle?.entry?.remove();

          const summary = "<strong>Proposed bands</strong>: equities " + (allocations.equities || "n/a") +
            ", fixed income " + (allocations.fixed_income || "n/a") +
            ", commodities " + (allocations.commodities || "n/a") +
            ", alternatives " + (allocations.alternatives || "n/a") +
            ", cash " + (allocations.cash || "n/a") +
            ".<br><br>" + justification;
          appendMessage("assistant", summary, { asHtml: true });
          applyAllocationSuggestion(allocations);
        } catch (err) {
          thinkingHandle?.entry?.remove();
          const friendly = err && err.message ? err.message : "Unable to reach backend.";
          appendMessage("assistant", "Error reaching backend: " + friendly);
        }
      }

      function handleAllocationConfirm(finalBands) {
        confirmedBands = finalBands;
        currentProposalId = currentProposalId || (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()));
        appendMessage("assistant", "User confirmed allocation bands.");

        const choiceContainer = document.createElement("div");
        choiceContainer.className = "choice-buttons";

        const yesBtn = document.createElement("button");
        yesBtn.type = "button";
        yesBtn.className = "btn btn-primary";
        yesBtn.textContent = "Yes, update data";
        yesBtn.addEventListener("click", () => handleDataRefreshChoice("y"));

        const noBtn = document.createElement("button");
        noBtn.type = "button";
        noBtn.className = "btn";
        noBtn.textContent = "No, use cached data";
        noBtn.addEventListener("click", () => handleDataRefreshChoice("n"));

        choiceContainer.appendChild(yesBtn);
        choiceContainer.appendChild(noBtn);

        const prompt = appendMessage(
          "assistant",
          "Refresh market data before optimizing? (y/n)"
        );
        prompt.bubble.appendChild(choiceContainer);
      }

      function handleDataRefreshChoice(choice) {
        const text = choice === "y"
          ? "Updating data and initializing optimization..."
          : "Using cached data. Initializing optimization...";
        appendMessage("assistant", text);
        runOptimization(choice, confirmedBands);
      }

      function normalizeWeights(optimizeResponse) {
        const weights = optimizeResponse?.weights ?? optimizeResponse?.asset_weights ?? optimizeResponse?.portfolio_weights;
        if (Array.isArray(weights)) return weights;
        if (weights && typeof weights === "object") {
          return Object.entries(weights).map(([ticker, weight]) => ({ ticker, weight }));
        }
        return [];
      }

      async function runOptimization(choice, bands) {
        const apiBase = getApiBaseUrl();
        const thinking = appendMessage("assistant", "Running optimizer...");
        try {
          if (choice === "y") {
            const refreshResponse = await fetch(apiBase + "/refresh_data", { method: "POST" });
            if (!refreshResponse.ok) {
              const detail = await readErrorDetail(refreshResponse);
              throw new Error(detail || "refresh_data failed (" + refreshResponse.status + ")");
            }
            const refreshData = await refreshResponse.json();
            appendMessage(
              "assistant",
              "Data refreshed: " + (refreshData?.rows ?? "?") + " rows, " + (refreshData?.tickers ?? "?") + " tickers."
            );
          }

          const optimizeResult = await postJson(apiBase + "/optimize", {
            proposal_id: currentProposalId,
            qualitative_allocations: bands
          });

          const normalized = normalizeWeights(optimizeResult).filter((item) => Number(item.weight) > 0.01);
          setWeightsTable(normalized);

          const weightLines = normalized.map((item) => item.ticker + ": " + (Number(item.weight) * 100).toFixed(0) + "%");
          const metrics = optimizeResult?.metrics;
          const metricsList = metrics && typeof metrics === "object"
            ? Object.entries(metrics).map(([k, v]) => k + ": " + (typeof v === "number" ? v.toFixed(4) : String(v)))
            : [];

          thinking?.entry?.remove();
          appendMessage(
            "assistant",
            "<strong>Optimization complete</strong><br>" +
            (weightLines.length ? weightLines.join("<br>") : "No weights returned.") +
            (metricsList.length
              ? "<br><br><ul class=\"md-list\">" + metricsList.map((m) => "<li>" + m + "</li>").join("") + "</ul>"
              : ""),
            { asHtml: true }
          );
        } catch (err) {
          thinking?.entry?.remove();
          const friendly = err && err.message ? err.message : "Unable to run optimization.";
          appendMessage("assistant", "Optimization error: " + friendly);
        }
      }

      async function handleSend() {
        const message = macroInput.value.trim();
        if (!message) return;
        appendMessage("user", message);
        macroInput.value = "";
        sendBtn.disabled = true;
        sendBtn.textContent = "Thinking...";
        const thinking = appendMessage("assistant", "Thinking...");
        try {
          await handleMacroViewSubmit(message, thinking);
        } finally {
          sendBtn.disabled = false;
          sendBtn.textContent = "Send";
        }
      }

      sendBtn?.addEventListener("click", handleSend);
      macroInput?.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey && !event.isComposing) {
          event.preventDefault();
          handleSend();
        }
      });

      confirmBandsBtn?.addEventListener("click", () => {
        const bands = readBandsFromForm();
        handleAllocationConfirm(bands);
      });

      // Seed the chat with a friendly system message.
      appendMessage(
        "assistant",
        "Enter a macro regime and any constraints. I'll propose asset-class allocation bands, then we can optimize."
      );
    }
  </script>
</body>
</html>
